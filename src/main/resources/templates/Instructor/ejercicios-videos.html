<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Ejercicios · Lista</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <style>
        :root{--bg:#0a0a0e;--card:#111118;--line:#1b1b25;--ink:#f2f2f2;--muted:#b7b7c2}
        body{background:var(--bg);color:var(--ink);font-family:Arial,Helvetica,sans-serif;margin:0}
        .containerx{max-width:1100px;margin:2rem auto;padding:0 1rem}
        .cardx{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:1rem;margin-bottom:1rem}
        table{width:100%;border-collapse:collapse}
        th,td{padding:.9rem 1rem;text-align:left}
        thead th{color:var(--muted);font-weight:700;border-bottom:1px solid rgba(255,255,255,.02)}
        tbody tr{border-bottom:1px solid rgba(255,255,255,.01)}
        .muted{color:var(--muted)}
        .actions { display:flex; gap:.5rem; justify-content:flex-end; }
        .btn { padding:.45rem .7rem; border-radius:6px; border:none; cursor:pointer; color:#fff; }
        .btn-edit{ background:#485fc7; } /* azul */
        .btn-delete{ background:#ff6b81; } /* rojo */
        .btn-view{ background:#2ecc71; } /* verde */
        .search { width:60%; padding:.6rem; border-radius:8px; border:1px solid #262626; background:#0f0f14; color:#fff }
        /* modal */
        .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.6); display:none; align-items:center; justify-content:center; z-index:2000 }
        .modal-card{ background:#0f0f14; border-radius:8px; padding:1rem; max-width:900px; width:95%; color:var(--ink); box-shadow:0 10px 30px rgba(0,0,0,.6) }
        .modal-video{ width:100%; height:480px; background:#000; border-radius:6px; overflow:hidden }
        @media (max-width:700px){ .modal-video{height:240px} }
    </style>
</head>
<body>
<nav class="containerx" style="padding:0">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:1rem">
        <div>
            <h1 style="margin:0;font-size:1.35rem">EJERCICIOS</h1>
            <div class="muted" style="margin-top:.25rem">Lista de ejercicios</div>
        </div>
        <div>
            <a th:href="@{/instructor/rutinas}" class="btn" style="background:#ffc107;color:#000;border-radius:8px;padding:.55rem .9rem">Volver</a>
        </div>
    </div>
</nav>

<main class="containerx">
    <div class="cardx">
        <div style="display:flex;gap:.75rem;align-items:center">
            <input id="searchInput" class="search" placeholder="Buscar por nombre, descripción o músculo" oninput="filterRows()" />
            <a th:href="@{/instructor/ejercicios/crear}" class="btn" style="background:#ffc107;color:#000;margin-left:auto;border-radius:8px;padding:.45rem .75rem">+ Nuevo ejercicio</a>
        </div>
    </div>

    <div class="cardx" th:if="${#lists.isEmpty(ejercicios)}">
        <div class="muted">No hay ejercicios registrados.</div>
    </div>

    <div class="cardx" th:if="${!#lists.isEmpty(ejercicios)}">
        <table aria-describedby="ejercicios-list">
            <thead>
            <tr>
                <th>Nombre</th>
                <th>Músculo</th>
                <th>Descripción</th>
                <th style="width:220px;text-align:right">Acciones</th>
            </tr>
            </thead>
            <tbody>
            <!-- Por fila: añade data-* con la info necesaria para el modal -->
            <tr th:each="e : ${ejercicios}"
                th:attr="data-text=${( (e.nombre != null ? e.nombre : '') + ' ' + (e.musculo != null ? e.musculo : '') + ' ' + (e.descripcion != null ? e.descripcion : '') ).toLowerCase() }"
                th:attrappend=" data-link=${e.linkVideo}, data-id=${e.id}, data-nombre=${e.nombre}, data-musculo=${e.musculo}, data-desc=${e.descripcion}">
                <td th:text="${e.nombre}">Nombre</td>
                <td th:text="${e.musculo}">Músculo</td>
                <td>
                    <div style="max-width:700px;white-space:pre-wrap;color:var(--muted)" th:text="${e.descripcion}">Descripción...</div>
                </td>
                <td>
                    <div class="actions" style="justify-content:flex-end">
                        <!-- BOTÓN VISTA: abre modal inline (sin recargar) -->
                        <button type="button" class="btn btn-view" th:onclick="'openExerciseModal(this.closest(\\'tr\\'))'">Vista</button>

                        <!-- BOTÓN EDITAR (mantener tu enlace actual) -->
                        <a th:href="@{|/instructor/ejercicios/editar/${e.id}|}" class="btn btn-edit">Editar</a>

                        <!-- FORM BORRAR (POST) -->
                        <form th:action="@{|/instructor/ejercicios/eliminar/${e.id}|}" method="post" style="display:inline">
                            <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            <button type="submit" class="btn btn-delete" onclick="return confirm('¿Eliminar ejercicio?');">Eliminar</button>
                        </form>
                    </div>
                </td>
            </tr>
            </tbody>
        </table>
    </div>
</main>

<!-- MODAL: Video + datos -->
<div id="videoModal" class="modal-backdrop" onclick="closeVideoModal(event)">
    <div class="modal-card" role="dialog" aria-modal="true" onclick="event.stopPropagation()">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem">
            <div style="font-weight:700" id="modalTitle">Vista ejercicio</div>
            <button onclick="closeVideoModal()" class="btn" style="background:#666;padding:.3rem .5rem">Cerrar</button>
        </div>

        <div>
            <div class="modal-video" id="modalVideoContainer">
                <!-- iframe injected dynamically -->
            </div>

            <div style="margin-top:.75rem">
                <div id="modalEjNombre" style="font-weight:700"></div>
                <div id="modalEjMusculo" class="muted"></div>
                <div id="modalEjDesc" style="margin-top:.5rem;white-space:pre-wrap;color:var(--muted)"></div>
            </div>
        </div>
    </div>
</div>

<script>
    function filterRows() {
        const q = (document.getElementById('searchInput').value || '').toLowerCase().trim();
        document.querySelectorAll('tbody tr').forEach(function(row) {
            const text = (row.getAttribute('data-text') || '').toLowerCase();
            row.style.display = text.indexOf(q) !== -1 ? '' : 'none';
        });
    }

    function extractYouTubeId(url) {
        if (!url) return null;
        url = url.trim();
        const short = url.match(/youtu\\.be\\/([a-zA-Z0-9_-]{6,})/);
        if (short && short[1]) return short[1];
        const embed = url.match(/youtube\\.com\\/embed\\/([a-zA-Z0-9_-]{6,})/);
        if (embed && embed[1]) return embed[1];
        const vparam = url.match(/[?&]v=([a-zA-Z0-9_-]{6,})/);
        if (vparam && vparam[1]) return vparam[1];
        const last = url.split('/').pop();
        if (last && last.length >= 6) return last.split('?')[0];
        return null;
    }

    function openExerciseModal(tr) {
        // tr is the <tr> element for that exercise
        const link = tr.getAttribute('data-link') || '';
        const nombre = tr.getAttribute('data-nombre') || tr.querySelector('td:nth-child(1)')?.textContent || '';
        const musculo = tr.getAttribute('data-musculo') || tr.querySelector('td:nth-child(2)')?.textContent || '';
        const desc = tr.getAttribute('data-desc') || tr.querySelector('td:nth-child(3)')?.textContent || '';

        document.getElementById('modalEjNombre').textContent = nombre;
        document.getElementById('modalEjMusculo').textContent = musculo;
        document.getElementById('modalEjDesc').textContent = desc;

        const container = document.getElementById('modalVideoContainer');
        container.innerHTML = '';

        const videoId = extractYouTubeId(link);
        if (!videoId) {
            container.innerHTML = '<div style="padding:1rem;color:var(--muted)">No hay link válido de YouTube para este ejercicio.</div>';
            document.getElementById('videoModal').style.display = 'flex';
            return;
        }

        const iframe = document.createElement('iframe');
        iframe.width = '100%';
        iframe.height = '100%';
        iframe.src = 'https://www.youtube.com/embed/' + encodeURIComponent(videoId) + '?rel=0';
        iframe.frameBorder = '0';
        iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture';
        iframe.allowFullscreen = true;
        container.appendChild(iframe);

        document.getElementById('videoModal').style.display = 'flex';
    }

    function closeVideoModal(ev) {
        if (ev && ev.target && ev.target.closest && ev.target.closest('.modal-card')) return;
        const modal = document.getElementById('videoModal');
        if (!modal) return;
        modal.style.display = 'none';
        const container = document.getElementById('modalVideoContainer');
        container.innerHTML = '';
    }
</script>
</body>
</html>