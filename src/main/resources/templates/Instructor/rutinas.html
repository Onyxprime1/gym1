<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Rutinas · Instructor</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <style>
        :root{--bg:#0a0a0e;--card:#111118;--line:#1b1b25;--ink:#f2f2f2;--muted:#b7b7c2;--accent:#ffc107}
        html,body{background:var(--bg);color:var(--ink);margin:0;padding:0;font-family:Arial,Helvetica,sans-serif}
        .containerx{max-width:1100px;margin:2rem auto;padding:0 1rem}
        .cardx{background:var(--card);border:1px solid var(--line);border-radius:10px;padding:1rem;margin-bottom:1rem}
        .muted{color:var(--muted)}
        .rutina-block{margin-bottom:1rem;padding:0;border-radius:10px;overflow:hidden}
        .rutina-header{display:flex;justify-content:space-between;align-items:flex-start;padding:1rem;background:rgba(255,255,255,0.01)}
        .rutina-body{padding:0 1rem 1rem 1rem; display:none;}
        .rutina-body.open{display:block;}
        .rutina-title{font-weight:700;font-size:1.05rem}
        table.detalles{width:100%;border-collapse:collapse;margin-top:.5rem}
        table.detalles th, table.detalles td{padding:.5rem .6rem;border-bottom:1px solid rgba(255,255,255,.02);text-align:left}
        table.detalles thead th{color:var(--muted);font-weight:700;font-size:.9rem}
        .actions { display:flex; gap:.5rem; align-items:center }
        .small-btn{padding:.35rem .55rem;border-radius:6px;text-decoration:none;cursor:pointer}
        .btn-delete{background:#ff6b81;color:#fff;border:none}
        .btn-assign{background:#3aa0ff;color:#fff;border:none}
        .field-inline { display:flex; gap:.4rem; align-items:center; }
        .edit-btn { background:#485fc7;color:#fff;border:none;padding:.25rem .4rem;border-radius:6px; cursor:pointer }
        .small-input { padding:.35rem .5rem;border-radius:6px;background:#0f0f14;border:1px solid #262626;color:#fff }
        .num { width:90px; padding:.35rem .5rem; border-radius:6px; background:#0f0f14; border:1px solid #262626; color:#fff }
        .note { color:var(--muted); font-size:.95rem; margin-top:.5rem; }
    </style>
</head>
<body>
<nav class="navbar">
    <div class="containerx" style="display:flex;align-items:center">
        <div class="brand">DEBUG Gym · Instructor</div>
    </div>
</nav>

<main>
    <div class="containerx">
        <div class="cardx">
            <h2 class="title is-4" style="margin:0;color:var(--ink)">Rutinas</h2>
            <p class="muted" style="margin-top:.5rem">Tus rutinas: pulsa "Abrir" para ver ejercicios, series y repeticiones. Puedes buscar y administrar.</p>

            <div style="margin-top:1rem; display:flex; gap:.5rem; align-items:center">
                <input id="searchInput" class="search" placeholder="Buscar por rutina, descripción o ejercicio..." oninput="filterRutinas()" style="width:100%;padding:.6rem;border-radius:8px;border:1px solid #262626;background:#0f0f14;color:#fff"/>
                <a th:href="@{/instructor/rutinas/crear}" class="small-btn btn-assign" style="margin-left:.5rem">Crear rutina</a>
            </div>
        </div>

        <div th:if="${#lists.isEmpty(rutinasViews)}" class="cardx muted">No hay rutinas registradas.</div>

        <!-- Itera rutinasViews -->
        <div th:each="rv : ${rutinasViews}" class="rutina-block cardx" th:attr="data-text=${rv.searchText}">
            <div class="rutina-header" th:attr="data-rid=${rv.rutina.id}">
                <div style="max-width:78%;">
                    <div><span class="rutina-title" th:text="${rv.rutina.nombre}">Nombre rutina</span></div>
                    <div class="muted" th:text="${rv.rutina.descripcion}">Descripción</div>
                </div>

                <div class="actions">
                    <button type="button" class="small-btn btn-open" onclick="toggleDetails(this)">Abrir</button>

                    <!-- Eliminar RUTINA completa (POST) -->
                    <form th:action="@{|/instructor/rutinas/eliminar/${rv.rutina.id}|}" method="post" style="display:inline" onsubmit="return confirm('¿Eliminar rutina?');">
                        <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <button type="submit" class="small-btn btn-delete">Eliminar</button>
                    </form>
                </div>
            </div>

            <div class="rutina-body" style="display:none">
                <div th:if="${#lists.isEmpty(rv.detalles)}" class="note" style="padding:1rem">No hay ejercicios asignados a esta rutina.</div>

                <table th:if="${!#lists.isEmpty(rv.detalles)}" class="detalles">
                    <thead>
                    <tr>
                        <th>Ejercicio</th>
                        <th>Día</th>
                        <th>Series</th>
                        <th>Repeticiones</th>
                        <th></th>
                    </tr>
                    </thead>
                    <tbody>
                    <!-- Un formulario POR FILA: editar y eliminar no afectan otras filas -->
                    <tr th:each="d : ${rv.detalles}">
                        <td th:text="${d.ejercicioNombre}">Ejercicio</td>

                        <!-- Visible inputs (kept outside the hidden row-edit form) -->
                        <td>
                            <input class="small-input row-dia" type="text" th:value="${d.diaSemana}" />
                        </td>

                        <td>
                            <input class="num row-series" type="number" min="0" th:value="${d.series != null ? d.series : ''}" />
                        </td>

                        <td>
                            <input class="num row-repes" type="number" min="0" th:value="${d.repeticiones != null ? d.repeticiones : ''}" />
                        </td>

                        <td>
                            <!-- Hidden forms to submit: one for detalleId case, one for fallback (ejercicioId) -->
                            <form th:if="${d.detalleId != null}" th:id="${'row-edit-form-' + d.detalleId}"
                                  th:action="@{|/instructor/rutinas/${rv.rutina.id}/detalles/editar/${d.detalleId}|}"
                                  method="post" style="display:inline;">
                                <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                <input type="hidden" name="dia" />
                                <input type="hidden" name="series" />
                                <input type="hidden" name="repeticiones" />
                            </form>

                            <form th:unless="${d.detalleId != null}" th:id="${'row-edit-form-fallback-' + rv.rutina.id + '-' + d.ejercicioId}"
                                  th:action="@{|/instructor/rutinas/${rv.rutina.id}/detalles/editar|}"
                                  method="post" style="display:inline;">
                                <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                <input type="hidden" name="ejercicioId" th:value="${d.ejercicioId}" />
                                <input type="hidden" name="dia" />
                                <input type="hidden" name="series" />
                                <input type="hidden" name="repeticiones" />
                            </form>

                            <!-- Edit button: no Thymeleaf expression in onclick, only data-* attrs -->
                            <button type="button" class="edit-btn"
                                    th:attr="data-rutina=${rv.rutina.id}, data-detalle=${d.detalleId}, data-ej=${d.ejercicioId}, data-fallback=${d.detalleId == null ? 'true' : 'false'}"
                                    onclick="submitRowEdit(this)">Editar</button>

                            <!-- Delete per-row (keeps existing behavior) -->
                            <span style="display:inline-block;margin-left:.5rem">
                                <form th:if="${d.detalleId != null}" th:action="@{|/instructor/rutinas/${rv.rutina.id}/detalles/eliminar/${d.detalleId}|}" method="post" style="display:inline" onsubmit="return confirm('¿Eliminar ejercicio de la rutina?');">
                                    <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                    <button class="small-btn btn-delete" type="submit">Eliminar</button>
                                </form>
                                <form th:unless="${d.detalleId != null}" th:action="@{|/instructor/rutinas/${rv.rutina.id}/detalles/eliminar|}" method="post" style="display:inline" onsubmit="return confirm('¿Eliminar ejercicio de la rutina?');">
                                    <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                    <input type="hidden" name="ejercicioId" th:value="${d.ejercicioId}" />
                                    <input type="hidden" name="diaSemana" th:value="${d.diaSemana}" />
                                    <button class="small-btn btn-delete" type="submit">Eliminar</button>
                                </form>
                            </span>
                        </td>
                    </tr>
                    </tbody>
                </table>

                <!-- Agregar nuevo detalle -->
                <div style="margin-top:0.75rem">
                    <form th:action="@{|/instructor/rutinas/${rv.rutina.id}/detalles/agregar|}" method="post" class="form-inline">
                        <input type="hidden" th:if="${_csrf != null}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                        <select name="ejercicioId" class="small-input" required>
                            <option value="">-- Ejercicio --</option>
                            <option th:each="e : ${ejercicios}" th:value="${e.id}" th:text="${e.nombre}">Ejercicio</option>
                        </select>

                        <input type="text" name="diaSemana" class="small-input" placeholder="Día (lunes, martes...)" />
                        <input type="number" name="series" class="small-input" placeholder="Series" min="1" style="width:100px"/>
                        <input type="number" name="repeticiones" class="small-input" placeholder="Repeticiones" min="1" style="width:120px"/>

                        <button type="submit" class="small-btn btn-assign">Agregar</button>
                    </form>
                </div>
            </div>
        </div>

        <div style="margin-top:.75rem">
            <a th:href="@{/instructor}" class="muted">Volver</a>
        </div>
    </div>
</main>

<script>
    function toggleDetails(btn) {
        const header = btn.closest('.rutina-header');
        const body = header.nextElementSibling;
        if (!body) return;
        const isOpen = body.classList.contains('open');
        document.querySelectorAll('.rutina-body.open').forEach(b => {
            if (b !== body) {
                b.classList.remove('open');
                b.style.display = 'none';
                const h = b.previousElementSibling;
                const ob = h && h.querySelector('.btn-open');
                if (ob) ob.textContent = 'Abrir';
            }
        });

        if (isOpen) {
            body.classList.remove('open');
            body.style.display = 'none';
            btn.textContent = 'Abrir';
        } else {
            body.classList.add('open');
            body.style.display = 'block';
            btn.textContent = 'Cerrar';
        }
    }

    function filterRutinas() {
        const q = (document.getElementById('searchInput').value || '').toLowerCase().trim();
        document.querySelectorAll('.rutina-block').forEach(function(node) {
            const text = (node.getAttribute('data-text') || '').toLowerCase();
            node.style.display = text.indexOf(q) !== -1 ? '' : 'none';
        });
    }

    // submitRowEdit: recibe el botón, lee dataset y copia los inputs visibles de la fila
    // a los campos ocultos del formulario correspondiente y lo envía.
    function submitRowEdit(button) {
        try {
            const btn = button;
            const rutinaId = btn.dataset.rutina;
            const detalleId = btn.dataset.detalle;
            const ejercicioId = btn.dataset.ej;
            const isFallback = btn.dataset.fallback === 'true';

            const tr = btn.closest('tr');
            if (!tr) return alert('Fila no encontrada');

            // localizar los visibles en la misma fila
            const diaInput = tr.querySelector('.row-dia');
            const seriesInput = tr.querySelector('.row-series');
            const repInput = tr.querySelector('.row-repes');

            const diaVal = diaInput ? diaInput.value : '';
            const seriesVal = seriesInput ? seriesInput.value : '';
            const repesVal = repInput ? repInput.value : '';

            if (!isFallback) {
                // detalleId path
                const formId = 'row-edit-form-' + detalleId;
                const form = document.getElementById(formId);
                if (!form) return alert('Formulario de edición no encontrado (detalleId).');
                form.querySelector('input[name="dia"]').value = diaVal;
                form.querySelector('input[name="series"]').value = seriesVal;
                form.querySelector('input[name="repeticiones"]').value = repesVal;
                form.submit();
            } else {
                // fallback path by ejercicioId
                const formId = 'row-edit-form-fallback-' + rutinaId + '-' + ejercicioId;
                const form = document.getElementById(formId);
                if (!form) return alert('Formulario de edición fallback no encontrado.');
                form.querySelector('input[name="dia"]').value = diaVal;
                form.querySelector('input[name="series"]').value = seriesVal;
                form.querySelector('input[name="repeticiones"]').value = repesVal;
                form.submit();
            }
        } catch (err) {
            console.error('submitRowEdit error', err);
            alert('Error al intentar editar la fila (mira consola).');
        }
    }
</script>
</body>
</html>